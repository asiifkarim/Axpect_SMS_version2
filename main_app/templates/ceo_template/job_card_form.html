{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{page_title}}{% endblock page_title %}

{% block custom_css %}
<style>
.form-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}
.required-field::after {
    content: " *";
    color: red;
}
.alert-info {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    color: #ffffff;
}
.alert-info small {
    color: #f0f0f0;
    font-weight: 500;
}
.custom-control-label {
    color: #ffffff !important;
    font-weight: 600;
}
.custom-control-input:checked ~ .custom-control-label::before {
    background-color: #ffc107;
    border-color: #ffc107;
}
#id_is_general_assignment {
    width: 20px;
    height: 20px;
    cursor: pointer;
    margin-right: 10px;
    vertical-align: middle;
    accent-color: #ffc107;
}
.alert-info i {
    color: #ffd54f;
}
</style>
{% endblock custom_css %}

{% block content %}
<div class="content-wrapper">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">{{page_title}}</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'admin_home' %}">Home</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'admin_job_card_dashboard' %}">Job Cards</a></li>
                        <li class="breadcrumb-item active">{{ form_action }}</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">{{ form_action }} Job Card</h3>
                        </div>
                        <form method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="card-body">
                                {% if form.errors %}
                                    <div class="alert alert-danger">
                                        <h5><i class="icon fas fa-ban"></i> Please correct the following errors:</h5>
                                        {% for field, errors in form.errors.items %}
                                            {% for error in errors %}
                                                <p>{{ field|capfirst }}: {{ error }}</p>
                                            {% endfor %}
                                        {% endfor %}
                                    </div>
                                {% endif %}

                                <!-- Basic Information -->
                                <div class="form-section">
                                    <h5 class="mb-3"><i class="fas fa-info-circle"></i> Basic Information</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="{{ form.title.id_for_label }}" class="required-field">Job Title</label>
                                                {{ form.title }}
                                                {% if form.title.help_text %}
                                                    <small class="form-text text-muted">{{ form.title.help_text }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="{{ form.priority.id_for_label }}" class="required-field">Priority</label>
                                                {{ form.priority }}
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="{{ form.type.id_for_label }}">Job Type</label>
                                                {{ form.type }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label for="{{ form.description.id_for_label }}" class="required-field">Description</label>
                                                {{ form.description }}
                                                {% if form.description.help_text %}
                                                    <small class="form-text text-muted">{{ form.description.help_text }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Assignment Details -->
                                <div class="form-section">
                                    <h5 class="mb-3"><i class="fas fa-user-tag"></i> Assignment Details</h5>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <div class="alert alert-info py-2">
                                                    <div class="custom-control custom-checkbox custom-control-inline">
                                                        {{ form.is_general_assignment }}
                                                        <label class="custom-control-label font-weight-bold" for="{{ form.is_general_assignment.id_for_label }}" style="font-size: 1.05em;">
                                                            <i class="fas fa-users mr-1"></i> {{ form.is_general_assignment.label }}
                                                        </label>
                                                    </div>
                                                    <small class="d-block mt-1 ml-4 pl-1">
                                                        <i class="fas fa-bell mr-1"></i> All employees will be notified when this option is selected
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group" id="assigned-to-group">
                                                <label for="{{ form.assigned_to.id_for_label }}">
                                                    <i class="fas fa-user mr-1"></i> Assign To Specific Employee
                                                </label>
                                                {{ form.assigned_to }}
                                                <small class="form-text text-muted">Or use "Assign to All Employees" above</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="{{ form.due_date.id_for_label }}">
                                                    <i class="fas fa-calendar mr-1"></i> Due Date & Time
                                                </label>
                                                {{ form.due_date }}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Work Details -->
                                <div class="form-section">
                                    <h5 class="mb-3"><i class="fas fa-briefcase"></i> Work Details</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="{{ form.customer.id_for_label }}">Customer</label>
                                                {{ form.customer }}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="{{ form.city.id_for_label }}">City</label>
                                                {{ form.city }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label for="{{ form.related_item.id_for_label }}">Related Item</label>
                                                {{ form.related_item }}
                                                <small class="form-text text-muted">Select related product or item if applicable</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <div class="card-footer">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> {{ form_action }} Job Card
                                </button>
                                <a href="{% url 'admin_job_card_dashboard' %}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock content %}

{% block custom_js %}
<script>
$(document).ready(function() {
    // Set minimum date to today for due date
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const dueDateInput = document.getElementById('{{ form.due_date.id_for_label }}');
    if (dueDateInput) {
        dueDateInput.min = tomorrow.toISOString().slice(0, 16);
    }
    
    // Handle general assignment checkbox
    const generalAssignmentCheckbox = $('#{{ form.is_general_assignment.id_for_label }}');
    const assignedToGroup = $('#assigned-to-group');
    const assignedToSelect = $('#{{ form.assigned_to.id_for_label }}');
    
    function toggleAssignedTo() {
        if (generalAssignmentCheckbox.is(':checked')) {
            assignedToGroup.hide();
            assignedToSelect.val('');
            assignedToSelect.prop('required', false);
        } else {
            assignedToGroup.show();
        }
    }
    
    // Initialize on page load
    toggleAssignedTo();
    
    // Toggle on checkbox change
    generalAssignmentCheckbox.on('change', toggleAssignedTo);
    
    // Form validation
    $('form').on('submit', function(e) {
        let isValid = true;
        
        // Check if either general assignment is checked or assigned_to is selected
        if (!generalAssignmentCheckbox.is(':checked') && !assignedToSelect.val()) {
            isValid = false;
            assignedToSelect.addClass('is-invalid');
            alert('Please either select an employee or check "Assign to All Employees"');
            e.preventDefault();
            return false;
        }
        
        // Check other required fields
        $('input[required], select[required], textarea[required]').each(function() {
            if (!$(this).val()) {
                isValid = false;
                $(this).addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('Please fill in all required fields.');
        }
    });
    
    // Remove invalid class on input
    $('input, select, textarea').on('input change', function() {
        $(this).removeClass('is-invalid');
    });
});
</script>
{% endblock custom_js %}
