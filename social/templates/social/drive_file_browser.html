{% extends "main_app/base.html" %}
{% load static %}

{% block page_title %}{{ page_title }}{% endblock %}

{% block custom_css %}
<style>
.file-browser {
    min-height: 500px;
}

.breadcrumb-nav {
    background: #f8f9fa;
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
}

.file-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    padding: 1rem;
}

.file-item {
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: white;
}

.file-item:hover {
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.15);
    transform: translateY(-2px);
}

.file-item.selected {
    border-color: #007bff;
    background: #e3f2fd;
}

.file-icon {
    font-size: 3rem;
    margin-bottom: 0.5rem;
    display: block;
}

.folder-icon {
    color: #ffc107;
}

.drive-file-icon {
    color: #4285f4;
}

.pdf-icon {
    color: #dc3545;
}

.word-icon {
    color: #0d6efd;
}

.excel-icon {
    color: #198754;
}

.image-icon {
    color: #6f42c1;
}

.file-name {
    font-weight: 500;
    margin-bottom: 0.25rem;
    word-break: break-word;
}

.file-info {
    font-size: 0.875rem;
    color: #6c757d;
}

.toolbar {
    background: white;
    border-bottom: 1px solid #dee2e6;
    padding: 1rem;
    display: flex;
    justify-content: between;
    align-items: center;
}

.view-toggle {
    display: flex;
    gap: 0.25rem;
}

.view-toggle .btn {
    padding: 0.375rem 0.75rem;
}

.search-box {
    flex: 1;
    max-width: 300px;
    margin: 0 1rem;
}

.loading-spinner {
    text-align: center;
    padding: 3rem;
}

.empty-folder {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
}

.empty-folder i {
    font-size: 4rem;
    margin-bottom: 1rem;
    color: #dee2e6;
}

.file-actions {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    opacity: 0;
    transition: opacity 0.2s;
}

.file-item:hover .file-actions {
    opacity: 1;
}

.share-modal .modal-body {
    max-height: 400px;
    overflow-y: auto;
}

.group-item {
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
}

.group-item:hover {
    background: #f8f9fa;
    border-color: #007bff;
}

.group-item.selected {
    background: #e3f2fd;
    border-color: #007bff;
}

.pagination-wrapper {
    padding: 1rem;
    border-top: 1px solid #dee2e6;
    background: #f8f9fa;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fab fa-google-drive mr-2"></i>Google Drive Files
                </h3>
                <div class="card-tools">
                    <a href="{% url 'social:google_drive_dashboard' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left"></i> Back to Drive Dashboard
                    </a>
                </div>
            </div>
            
            <!-- Breadcrumb Navigation -->
            <div class="breadcrumb-nav">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item">
                            <a href="?folder=root"><i class="fab fa-google-drive mr-1"></i>My Drive</a>
                        </li>
                        {% if current_folder != 'root' %}
                            <li class="breadcrumb-item active">Current Folder</li>
                        {% endif %}
                    </ol>
                </nav>
            </div>
            
            <!-- Toolbar -->
            <div class="toolbar">
                <div class="view-toggle">
                    <button type="button" class="btn btn-outline-secondary active" id="gridView">
                        <i class="fas fa-th"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="listView">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
                
                <div class="search-box">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search files..." id="fileSearch">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div>
                    <button type="button" class="btn btn-primary" id="shareSelectedBtn" disabled>
                        <i class="fas fa-share"></i> Share Selected
                    </button>
                </div>
            </div>
            
            <!-- File Browser -->
            <div class="file-browser">
                {% if folders or files %}
                    <div class="file-grid" id="fileGrid">
                        <!-- Folders -->
                        {% for folder in folders %}
                            <div class="file-item folder-item" data-folder-id="{{ folder.id }}">
                                <i class="fas fa-folder file-icon folder-icon"></i>
                                <div class="file-name">{{ folder.name }}</div>
                                <div class="file-info">Folder</div>
                            </div>
                        {% endfor %}
                        
                        <!-- Files -->
                        {% for file in files %}
                            <div class="file-item file-selectable" data-file-id="{{ file.id }}" data-file-name="{{ file.name }}">
                                <div class="file-actions">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="previewFile('{{ file.id }}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                
                                {% if 'image' in file.mimeType %}
                                    <i class="fas fa-image file-icon image-icon"></i>
                                {% elif 'pdf' in file.mimeType %}
                                    <i class="fas fa-file-pdf file-icon pdf-icon"></i>
                                {% elif 'word' in file.mimeType or 'document' in file.mimeType %}
                                    <i class="fas fa-file-word file-icon word-icon"></i>
                                {% elif 'sheet' in file.mimeType or 'excel' in file.mimeType %}
                                    <i class="fas fa-file-excel file-icon excel-icon"></i>
                                {% else %}
                                    <i class="fab fa-google-drive file-icon drive-file-icon"></i>
                                {% endif %}
                                
                                <div class="file-name">{{ file.name }}</div>
                                <div class="file-info">
                                    {% if file.size %}
                                        {{ file.size|filesizeformat }}
                                    {% else %}
                                        Google Doc
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Pagination -->
                    {% if next_page_token %}
                        <div class="pagination-wrapper text-center">
                            <a href="?folder={{ current_folder }}&page_token={{ next_page_token }}" class="btn btn-outline-primary">
                                <i class="fas fa-chevron-down mr-2"></i>Load More Files
                            </a>
                        </div>
                    {% endif %}
                    
                {% else %}
                    <div class="empty-folder">
                        <i class="fas fa-folder-open"></i>
                        <h4>No files found</h4>
                        <p>This folder is empty or you don't have access to any files.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Share File Modal -->
<div class="modal fade" id="shareFileModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share Files in Chat</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="selectedFilesInfo" class="mb-3"></div>
                
                <h6>Select a chat group:</h6>
                <div id="groupsList">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        Loading groups...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmShareBtn" disabled>Share Files</button>
            </div>
        </div>
    </div>
</div>

<!-- File Preview Modal -->
<div class="modal fade" id="filePreviewModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewFileName">File Preview</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="filePreviewContent" class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <a href="#" class="btn btn-primary" id="openInDriveBtn" target="_blank">
                    <i class="fab fa-google-drive mr-2"></i>Open in Drive
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script>
let selectedFiles = [];
let selectedGroup = null;

$(document).ready(function() {
    // Folder navigation
    $('.folder-item').click(function() {
        const folderId = $(this).data('folder-id');
        window.location.href = `?folder=${folderId}`;
    });
    
    // File selection
    $('.file-selectable').click(function(e) {
        if ($(e.target).closest('.file-actions').length) return;
        
        $(this).toggleClass('selected');
        updateSelectedFiles();
    });
    
    // View toggle
    $('#gridView, #listView').click(function() {
        $('.view-toggle .btn').removeClass('active');
        $(this).addClass('active');
        
        if ($(this).attr('id') === 'listView') {
            $('#fileGrid').removeClass('file-grid').addClass('list-group');
            $('.file-item').addClass('list-group-item').css('display', 'flex');
        } else {
            $('#fileGrid').removeClass('list-group').addClass('file-grid');
            $('.file-item').removeClass('list-group-item').css('display', 'block');
        }
    });
    
    // File search
    $('#fileSearch').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('.file-item').each(function() {
            const fileName = $(this).find('.file-name').text().toLowerCase();
            if (fileName.includes(searchTerm)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });
    
    // Share selected files
    $('#shareSelectedBtn').click(function() {
        if (selectedFiles.length === 0) return;
        
        showShareModal();
    });
});

function updateSelectedFiles() {
    selectedFiles = [];
    $('.file-selectable.selected').each(function() {
        selectedFiles.push({
            id: $(this).data('file-id'),
            name: $(this).data('file-name')
        });
    });
    
    $('#shareSelectedBtn').prop('disabled', selectedFiles.length === 0);
    
    if (selectedFiles.length > 0) {
        $('#shareSelectedBtn').html(`<i class="fas fa-share"></i> Share Selected (${selectedFiles.length})`);
    } else {
        $('#shareSelectedBtn').html('<i class="fas fa-share"></i> Share Selected');
    }
}

function showShareModal() {
    // Update selected files info
    let filesInfo = '<strong>Selected files:</strong><ul class="mb-0">';
    selectedFiles.forEach(file => {
        filesInfo += `<li>${file.name}</li>`;
    });
    filesInfo += '</ul>';
    $('#selectedFilesInfo').html(filesInfo);
    
    // Load user groups
    loadUserGroups();
    
    $('#shareFileModal').modal('show');
}

function loadUserGroups() {
    $('#groupsList').html(`
        <div class="text-center">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            Loading groups...
        </div>
    `);
    
    $.get('/social/api/groups/')
        .done(function(data) {
            let html = '';
            if (data.length === 0) {
                html = '<div class="text-muted text-center">No groups available</div>';
            } else {
                data.forEach(group => {
                    html += `
                        <div class="group-item" data-group-id="${group.id}">
                            <div class="d-flex align-items-center">
                                <div class="mr-3">
                                    ${group.group_type === 'DEPARTMENT' ? '<i class="fas fa-users text-info"></i>' : 
                                      group.group_type === 'DIRECT' ? '<i class="fas fa-user text-primary"></i>' : 
                                      '<i class="fas fa-layer-group text-success"></i>'}
                                </div>
                                <div class="flex-grow-1">
                                    <div class="font-weight-bold">${group.name}</div>
                                    <small class="text-muted">${group.member_count} members</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            $('#groupsList').html(html);
            
            // Group selection
            $('.group-item').click(function() {
                $('.group-item').removeClass('selected');
                $(this).addClass('selected');
                selectedGroup = $(this).data('group-id');
                $('#confirmShareBtn').prop('disabled', false);
            });
        })
        .fail(function() {
            $('#groupsList').html('<div class="alert alert-danger">Failed to load groups</div>');
        });
}

$('#confirmShareBtn').click(function() {
    if (!selectedGroup || selectedFiles.length === 0) return;
    
    const btn = $(this);
    const originalText = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin mr-2"></i>Sharing...').prop('disabled', true);
    
    // Share each file
    let sharePromises = selectedFiles.map(file => {
        return $.post(`/social/api/drive/files/${file.id}/attach/`, {
            group_id: selectedGroup,
            content: `📎 ${file.name}`
        });
    });
    
    Promise.all(sharePromises)
        .then(() => {
            $('#shareFileModal').modal('hide');
            alert(`Successfully shared ${selectedFiles.length} file(s)!`);
            
            // Clear selection
            $('.file-selectable').removeClass('selected');
            updateSelectedFiles();
        })
        .catch(() => {
            alert('Failed to share some files. Please try again.');
        })
        .finally(() => {
            btn.html(originalText).prop('disabled', false);
        });
});

function previewFile(fileId) {
    $('#filePreviewModal').modal('show');
    $('#filePreviewContent').html(`
        <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    `);
    
    $.get(`/social/api/drive/files/${fileId}/`)
        .done(function(data) {
            $('#previewFileName').text(data.name);
            $('#openInDriveBtn').attr('href', data.webViewLink);
            
            let previewContent = '';
            if (data.thumbnailLink) {
                previewContent = `<img src="${data.thumbnailLink}" class="img-fluid" alt="File preview">`;
            } else {
                previewContent = `
                    <div class="text-center py-5">
                        <i class="fab fa-google-drive fa-5x text-primary mb-3"></i>
                        <h5>${data.name}</h5>
                        <p class="text-muted">Preview not available. Click "Open in Drive" to view the file.</p>
                    </div>
                `;
            }
            
            $('#filePreviewContent').html(previewContent);
        })
        .fail(function() {
            $('#filePreviewContent').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Failed to load file preview.
                </div>
            `);
        });
}

// Reset modal state when closed
$('#shareFileModal').on('hidden.bs.modal', function() {
    selectedGroup = null;
    $('#confirmShareBtn').prop('disabled', true);
    $('.group-item').removeClass('selected');
});
</script>
{% endblock %}
