{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}Enhanced Job Card Dashboard{% endblock page_title %}

{% block custom_css %}
<style>
/* Enhanced Job Card Dashboard Styles */
.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
}

.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    text-align: center;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 10px;
}

.filter-section {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
}

.job-card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.job-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.job-card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    transform: translateY(-3px);
}

.job-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.job-card-number {
    font-size: 1.2rem;
    font-weight: bold;
    color: #495057;
}

.job-card-badges {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.status-badge, .priority-badge {
    font-size: 0.75rem;
    padding: 4px 10px;
    border-radius: 15px;
    font-weight: 600;
    text-transform: uppercase;
}

.job-card-body {
    margin-bottom: 15px;
}

.job-card-description {
    color: #6c757d;
    font-size: 0.9rem;
    line-height: 1.4;
    margin-bottom: 10px;
}

.job-card-meta {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    font-size: 0.85rem;
    color: #6c757d;
}

.job-card-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

.quick-assign-section {
    background: #e3f2fd;
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
}

.employee-select {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.employee-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #007bff;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.employee-avatar:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0,123,255,0.3);
}

.bulk-actions {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    display: none;
}

.bulk-actions.show {
    display: block;
}

/* Status Colors */
.status-pending { background-color: #ffc107; color: #212529; }
.status-in-progress { background-color: #17a2b8; color: white; }
.status-completed { background-color: #28a745; color: white; }
.status-on-hold { background-color: #6c757d; color: white; }
.status-cancelled { background-color: #dc3545; color: white; }
.status-assigned { background-color: #007bff; color: white; }

/* Priority Colors */
.priority-low { background-color: #28a745; color: white; }
.priority-medium { background-color: #ffc107; color: #212529; }
.priority-high { background-color: #fd7e14; color: white; }
.priority-urgent { background-color: #dc3545; color: white; }

/* Responsive Design */
@media (max-width: 768px) {
    .job-card-grid {
        grid-template-columns: 1fr;
    }
    
    .dashboard-stats {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .job-card-meta {
        grid-template-columns: 1fr;
    }
}

/* Loading States */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Enhanced Assignment Modal */
.assignment-modal .modal-content {
    border-radius: 15px;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.assignment-modal .modal-header {
    border-radius: 15px 15px 0 0;
    border-bottom: none;
    padding: 25px;
}

.assignment-modal .modal-body {
    padding: 25px;
}

.assignment-details {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.employee-info {
    background: white;
    border-radius: 8px;
    padding: 15px;
    border: 2px solid #e9ecef;
}

.employee-info.selected {
    border-color: #007bff;
    background: #e3f2fd;
}
</style>
{% endblock custom_css %}

{% block main_content %}
<div class="content-wrapper">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">Enhanced Job Card Dashboard</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'admin_home' %}">Home</a></li>
                        <li class="breadcrumb-item active">Job Cards</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2><i class="fas fa-tasks me-3"></i>Job Card Management</h2>
                        <p class="mb-0">Manage and assign job cards with enhanced notifications and real-time updates</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="{% url 'admin_create_job_card' %}" class="btn btn-light btn-lg">
                            <i class="fas fa-plus me-2"></i>Create New Job Card
                        </a>
                    </div>
                </div>
            </div>

            <!-- Dashboard Stats -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-number text-primary" id="total-jobs">{{ total_job_cards }}</div>
                    <div class="stat-label">Total Job Cards</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number text-warning" id="pending-jobs">{{ pending_jobs }}</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number text-info" id="in-progress-jobs">{{ in_progress_jobs }}</div>
                    <div class="stat-label">In Progress</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number text-success" id="completed-jobs">{{ completed_jobs }}</div>
                    <div class="stat-label">Completed</div>
                </div>
            </div>

            <!-- Enhanced Filters -->
            <div class="filter-section">
                <form method="GET" id="filter-form">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="status-filter">Status</label>
                            <select name="status" id="status-filter" class="form-control">
                                <option value="">All Statuses</option>
                                <option value="PENDING" {% if request.GET.status == 'PENDING' %}selected{% endif %}>Pending</option>
                                <option value="ASSIGNED" {% if request.GET.status == 'ASSIGNED' %}selected{% endif %}>Assigned</option>
                                <option value="IN_PROGRESS" {% if request.GET.status == 'IN_PROGRESS' %}selected{% endif %}>In Progress</option>
                                <option value="COMPLETED" {% if request.GET.status == 'COMPLETED' %}selected{% endif %}>Completed</option>
                                <option value="ON_HOLD" {% if request.GET.status == 'ON_HOLD' %}selected{% endif %}>On Hold</option>
                                <option value="CANCELLED" {% if request.GET.status == 'CANCELLED' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="priority-filter">Priority</label>
                            <select name="priority" id="priority-filter" class="form-control">
                                <option value="">All Priorities</option>
                                <option value="LOW" {% if request.GET.priority == 'LOW' %}selected{% endif %}>Low</option>
                                <option value="MEDIUM" {% if request.GET.priority == 'MEDIUM' %}selected{% endif %}>Medium</option>
                                <option value="HIGH" {% if request.GET.priority == 'HIGH' %}selected{% endif %}>High</option>
                                <option value="URGENT" {% if request.GET.priority == 'URGENT' %}selected{% endif %}>Urgent</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="assigned-to-filter">Assigned To</label>
                            <select name="assigned_to" id="assigned-to-filter" class="form-control">
                                <option value="">All Employees</option>
                                {% for employee in employees %}
                                <option value="{{ employee.id }}" {% if request.GET.assigned_to == employee.id|stringformat:"s" %}selected{% endif %}>
                                    {{ employee.get_full_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="search-filter">Search</label>
                            <div class="input-group">
                                <input type="text" name="search" id="search-filter" class="form-control" 
                                       placeholder="Search job cards..." value="{{ request.GET.search }}">
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                                <i class="fas fa-times me-2"></i>Clear Filters
                            </button>
                            <button type="button" class="btn btn-info" onclick="toggleBulkActions()">
                                <i class="fas fa-check-square me-2"></i>Bulk Actions
                            </button>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-primary active" onclick="setView('grid')">
                                    <i class="fas fa-th-large"></i> Grid
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="setView('list')">
                                    <i class="fas fa-list"></i> List
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Bulk Actions Panel -->
            <div class="bulk-actions" id="bulk-actions-panel">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <span id="selected-count">0</span> job cards selected
                    </div>
                    <div class="col-md-6 text-end">
                        <button type="button" class="btn btn-primary bulk-assign-btn">
                            <i class="fas fa-user-plus me-2"></i>Bulk Assign
                        </button>
                        <button type="button" class="btn btn-warning" onclick="bulkUpdateStatus()">
                            <i class="fas fa-edit me-2"></i>Update Status
                        </button>
                        <button type="button" class="btn btn-danger" onclick="bulkDelete()">
                            <i class="fas fa-trash me-2"></i>Delete Selected
                        </button>
                    </div>
                </div>
            </div>

            <!-- Job Cards Grid -->
            <div class="job-card-grid" id="job-cards-container">
                {% for job_card in job_cards %}
                <div class="job-card" data-jobcard-id="{{ job_card.id }}">
                    <div class="job-card-header">
                        <div>
                            <input type="checkbox" class="job-card-checkbox" value="{{ job_card.id }}" style="display: none;">
                            <div class="job-card-number">#{{ job_card.job_card_number }}</div>
                            <small class="text-muted">{{ job_card.type }}</small>
                        </div>
                        <div class="job-card-badges">
                            <span class="status-badge status-{{ job_card.status|lower }}">{{ job_card.status }}</span>
                            <span class="priority-badge priority-{{ job_card.priority|lower }}">{{ job_card.priority }}</span>
                        </div>
                    </div>

                    <div class="job-card-body">
                        <div class="job-card-description">
                            {{ job_card.description|truncatechars:100 }}
                        </div>
                        
                        <div class="job-card-meta">
                            <div>
                                <i class="fas fa-user text-muted me-1"></i>
                                <small>{{ job_card.assigned_to.get_full_name|default:"Unassigned" }}</small>
                            </div>
                            <div>
                                <i class="fas fa-calendar text-muted me-1"></i>
                                <small>{{ job_card.created_at|date:"M d, Y" }}</small>
                            </div>
                            {% if job_card.customer %}
                            <div>
                                <i class="fas fa-building text-muted me-1"></i>
                                <small>{{ job_card.customer.name }}</small>
                            </div>
                            {% endif %}
                            {% if job_card.due_date %}
                            <div>
                                <i class="fas fa-clock text-muted me-1"></i>
                                <small>Due: {{ job_card.due_date|date:"M d, Y" }}</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="job-card-actions">
                        <a href="{% url 'admin_job_card_detail' job_card.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye me-1"></i>View
                        </a>
                        <a href="{% url 'admin_edit_job_card' job_card.id %}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-edit me-1"></i>Edit
                        </a>
                        
                        {% if not job_card.assigned_to %}
                        <div class="dropdown">
                            <button class="btn btn-sm btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-plus me-1"></i>Assign
                            </button>
                            <div class="dropdown-menu">
                                {% for employee in employees %}
                                <a class="dropdown-item quick-assign-btn" href="#" 
                                   data-jobcard-id="{{ job_card.id }}" 
                                   data-employee-id="{{ employee.id }}"
                                   data-employee-name="{{ employee.get_full_name }}">
                                    <div class="employee-avatar me-2">{{ employee.first_name.0 }}{{ employee.last_name.0 }}</div>
                                    {{ employee.get_full_name }}
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                        {% else %}
                        <button class="btn btn-sm btn-warning reassign-btn" 
                                data-jobcard-id="{{ job_card.id }}"
                                data-current-assignee="{{ job_card.assigned_to.get_full_name }}">
                            <i class="fas fa-exchange-alt me-1"></i>Reassign
                        </button>
                        {% endif %}

                        <select class="form-select form-select-sm job-status-select" 
                                data-jobcard-id="{{ job_card.id }}" 
                                data-old-status="{{ job_card.status }}"
                                style="width: auto; display: inline-block;">
                            <option value="PENDING" {% if job_card.status == 'PENDING' %}selected{% endif %}>Pending</option>
                            <option value="ASSIGNED" {% if job_card.status == 'ASSIGNED' %}selected{% endif %}>Assigned</option>
                            <option value="IN_PROGRESS" {% if job_card.status == 'IN_PROGRESS' %}selected{% endif %}>In Progress</option>
                            <option value="COMPLETED" {% if job_card.status == 'COMPLETED' %}selected{% endif %}>Completed</option>
                            <option value="ON_HOLD" {% if job_card.status == 'ON_HOLD' %}selected{% endif %}>On Hold</option>
                            <option value="CANCELLED" {% if job_card.status == 'CANCELLED' %}selected{% endif %}>Cancelled</option>
                        </select>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle fa-2x mb-3"></i>
                        <h5>No Job Cards Found</h5>
                        <p>No job cards match your current filters. Try adjusting your search criteria or create a new job card.</p>
                        <a href="{% url 'admin_create_job_card' %}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Create New Job Card
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
            <div class="row mt-4">
                <div class="col-12">
                    <nav aria-label="Job cards pagination">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}{% if request.GET.assigned_to %}&assigned_to={{ request.GET.assigned_to }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">First</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}{% if request.GET.assigned_to %}&assigned_to={{ request.GET.assigned_to }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">Previous</a>
                            </li>
                            {% endif %}

                            <li class="page-item active">
                                <span class="page-link">{{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                            </li>

                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}{% if request.GET.assigned_to %}&assigned_to={{ request.GET.assigned_to }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">Next</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}{% if request.GET.assigned_to %}&assigned_to={{ request.GET.assigned_to }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">Last</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
            {% endif %}
        </div>
    </section>
</div>
{% endblock main_content %}

{% block custom_js %}
<script>
// Enhanced Job Card Dashboard JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Initialize enhanced features
    initializeEnhancedFeatures();
    
    // Auto-refresh every 2 minutes
    setInterval(refreshDashboardStats, 120000);
});

function initializeEnhancedFeatures() {
    // Initialize filter change handlers
    document.getElementById('status-filter').addEventListener('change', function() {
        document.getElementById('filter-form').submit();
    });
    
    document.getElementById('priority-filter').addEventListener('change', function() {
        document.getElementById('filter-form').submit();
    });
    
    document.getElementById('assigned-to-filter').addEventListener('change', function() {
        document.getElementById('filter-form').submit();
    });
    
    // Initialize bulk selection
    initializeBulkSelection();
    
    // Show success message if job card was just created/updated
    {% if messages %}
    {% for message in messages %}
    notificationManager.{{ message.tags }}('{{ message }}');
    {% endfor %}
    {% endif %}
}

function clearFilters() {
    window.location.href = window.location.pathname;
}

function setView(viewType) {
    // Toggle between grid and list view
    const container = document.getElementById('job-cards-container');
    const buttons = document.querySelectorAll('.btn-group .btn');
    
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    if (viewType === 'list') {
        container.classList.add('list-view');
    } else {
        container.classList.remove('list-view');
    }
}

function toggleBulkActions() {
    const panel = document.getElementById('bulk-actions-panel');
    const checkboxes = document.querySelectorAll('.job-card-checkbox');
    
    if (panel.classList.contains('show')) {
        panel.classList.remove('show');
        checkboxes.forEach(cb => cb.style.display = 'none');
        updateSelectedCount();
    } else {
        panel.classList.add('show');
        checkboxes.forEach(cb => cb.style.display = 'inline-block');
    }
}

function initializeBulkSelection() {
    const checkboxes = document.querySelectorAll('.job-card-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
}

function updateSelectedCount() {
    const selected = document.querySelectorAll('.job-card-checkbox:checked');
    document.getElementById('selected-count').textContent = selected.length;
}

function bulkUpdateStatus() {
    const selected = document.querySelectorAll('.job-card-checkbox:checked');
    if (selected.length === 0) {
        notificationManager.warning('Please select at least one job card');
        return;
    }
    
    const newStatus = prompt('Enter new status (PENDING, IN_PROGRESS, COMPLETED, ON_HOLD, CANCELLED):');
    if (!newStatus) return;
    
    const jobCardIds = Array.from(selected).map(cb => cb.value);
    
    // Bulk update implementation
    notificationManager.info(`Updating ${jobCardIds.length} job cards to ${newStatus}...`);
    
    // This would make API calls to update each job card
    // For now, just show a success message
    setTimeout(() => {
        notificationManager.success(`Successfully updated ${jobCardIds.length} job cards`);
        location.reload();
    }, 1000);
}

function bulkDelete() {
    const selected = document.querySelectorAll('.job-card-checkbox:checked');
    if (selected.length === 0) {
        notificationManager.warning('Please select at least one job card');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${selected.length} job cards? This action cannot be undone.`)) {
        return;
    }
    
    const jobCardIds = Array.from(selected).map(cb => cb.value);
    
    // Bulk delete implementation
    notificationManager.info(`Deleting ${jobCardIds.length} job cards...`);
    
    // This would make API calls to delete each job card
    // For now, just show a success message
    setTimeout(() => {
        notificationManager.success(`Successfully deleted ${jobCardIds.length} job cards`);
        location.reload();
    }, 1000);
}

function refreshDashboardStats() {
    fetch('/api/dashboard/job-card-stats/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('total-jobs').textContent = data.total;
                document.getElementById('pending-jobs').textContent = data.pending;
                document.getElementById('in-progress-jobs').textContent = data.in_progress;
                document.getElementById('completed-jobs').textContent = data.completed;
            }
        })
        .catch(error => {
            console.error('Error refreshing stats:', error);
        });
}

// Real-time updates
function handleJobCardUpdate(update) {
    const jobCard = document.querySelector(`[data-jobcard-id="${update.job_card_id}"]`);
    if (jobCard) {
        // Update the job card UI based on the update type
        switch (update.type) {
            case 'status_change':
                updateJobCardStatus(jobCard, update.new_status);
                break;
            case 'assignment_change':
                updateJobCardAssignment(jobCard, update.assigned_to);
                break;
        }
    }
}

function updateJobCardStatus(jobCard, newStatus) {
    const statusBadge = jobCard.querySelector('.status-badge');
    const statusSelect = jobCard.querySelector('.job-status-select');
    
    if (statusBadge) {
        statusBadge.className = `status-badge status-${newStatus.toLowerCase()}`;
        statusBadge.textContent = newStatus;
    }
    
    if (statusSelect) {
        statusSelect.value = newStatus;
        statusSelect.dataset.oldStatus = newStatus;
    }
}

function updateJobCardAssignment(jobCard, assignedTo) {
    const metaSection = jobCard.querySelector('.job-card-meta');
    const userInfo = metaSection.querySelector('div:first-child small');
    
    if (userInfo) {
        userInfo.textContent = assignedTo || 'Unassigned';
    }
}

// Initialize real-time updates if WebSocket is available
if (window.notificationManager) {
    // This would be handled by the notification manager's real-time system
    console.log('Real-time job card updates initialized');
}
</script>
{% endblock custom_js %}
