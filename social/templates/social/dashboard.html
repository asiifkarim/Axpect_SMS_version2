{% extends "main_app/base.html" %}
{% load static %}
{% load social_filters %}

{% block page_title %}{{ page_title }}{% endblock %}

{% block custom_css %}
<style>
.chat-list {
    max-height: 600px;
    overflow-y: auto;
}

.chat-item {
    border-bottom: 1px solid #dee2e6;
    transition: background-color 0.2s;
}

.chat-item:hover {
    background-color: #f8f9fa;
}

.chat-item:last-child {
    border-bottom: none;
}

.chat-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
}

.chat-preview {
    font-size: 0.9em;
    color: #6c757d;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.unread-badge {
    background-color: #007bff;
    color: white;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 0.75em;
    min-width: 20px;
    text-align: center;
}

.online-indicator {
    width: 12px;
    height: 12px;
    background-color: #28a745;
    border: 2px solid white;
    border-radius: 50%;
    position: absolute;
    bottom: 2px;
    right: 2px;
}

.group-type-badge {
    font-size: 0.7em;
    padding: 2px 6px;
    border-radius: 10px;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 20px;
    color: #dee2e6;
}

.quick-actions {
    margin-bottom: 20px;
}

.search-box {
    margin-bottom: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-comments mr-2"></i>Messages
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#newGroupModal">
                        <i class="fas fa-plus"></i> New Group
                    </button>
                    <button type="button" class="btn btn-info btn-sm" data-toggle="modal" data-target="#startDMModal">
                        <i class="fas fa-user"></i> Start DM
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- Search Box -->
                <div class="search-box p-3">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search conversations..." id="searchChats">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Chat List -->
                {% if groups_with_messages %}
                <div class="chat-list">
                    {% for item in groups_with_messages %}
                    <div class="chat-item p-3" data-group-id="{{ item.group.id }}">
                        <div class="d-flex align-items-center">
                            <div class="position-relative mr-3">
                                {% if item.group.group_type == 'DIRECT' %}
                                    <!-- For DM, show other user's avatar -->
                                    {% for member in item.group.members.all %}
                                        {% if member.user != request.user %}
                                            <img src="{{ member.user.profile_pic.url|default:'/static/dist/img/default-150x150.png' }}" 
                                                 alt="Avatar" class="chat-avatar">
                                            {% if member.user.is_online %}
                                                <span class="online-indicator"></span>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <!-- For groups, show group icon -->
                                    <div class="chat-avatar bg-primary d-flex align-items-center justify-content-center text-white">
                                        {% if item.group.group_type == 'DEPARTMENT' %}
                                            <i class="fas fa-users"></i>
                                        {% else %}
                                            <i class="fas fa-layer-group"></i>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">
                                            {{ item.group|dm_display_name:request.user }}
                                            {% if item.group.group_type == 'DEPARTMENT' %}
                                                <span class="badge badge-info group-type-badge">Dept</span>
                                            {% elif item.group.group_type == 'CUSTOM' %}
                                                <span class="badge badge-success group-type-badge">Group</span>
                                            {% elif item.group.group_type == 'DIRECT' %}
                                                <span class="badge badge-primary group-type-badge">DM</span>
                                            {% endif %}
                                        </h6>
                                        {% if item.latest_message %}
                                            <p class="chat-preview mb-0">
                                                <strong>{{ item.latest_message.sender.first_name }}:</strong>
                                                {% if item.latest_message.message_type == 'DRIVE_FILE' %}
                                                    <i class="fab fa-google-drive"></i> {{ item.latest_message.drive_file_name }}
                                                {% elif item.latest_message.message_type == 'IMAGE' %}
                                                    <i class="fas fa-image"></i> Image
                                                {% elif item.latest_message.message_type == 'FILE' %}
                                                    <i class="fas fa-file"></i> {{ item.latest_message.file_name }}
                                                {% else %}
                                                    {{ item.latest_message.content|truncatechars:50 }}
                                                {% endif %}
                                            </p>
                                        {% else %}
                                            <p class="chat-preview mb-0 text-muted">No messages yet</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="text-right">
                                        {% if item.latest_message %}
                                            <small class="text-muted">{{ item.latest_message.created_at|timesince }} ago</small>
                                        {% endif %}
                                        {% if item.unread_count > 0 %}
                                            <div class="mt-1">
                                                <span class="unread-badge">{{ item.unread_count }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <h4>No conversations yet</h4>
                    <p>Start a conversation by creating a group or sending a direct message.</p>
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#startDMModal">
                        <i class="fas fa-user"></i> Start Your First Chat
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-bolt mr-2"></i>Quick Actions
                </h3>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary btn-block mb-2" data-toggle="modal" data-target="#startDMModal">
                        <i class="fas fa-user mr-2"></i>Start Direct Message
                    </button>
                    <button type="button" class="btn btn-outline-success btn-block mb-2" data-toggle="modal" data-target="#newGroupModal">
                        <i class="fas fa-users mr-2"></i>Create Group Chat
                    </button>
                    <a href="{% url 'social:google_drive_dashboard' %}" class="btn btn-outline-info btn-block mb-2">
                        <i class="fab fa-google-drive mr-2"></i>Google Drive
                    </a>
                    <a href="{% url 'social:notification_settings' %}" class="btn btn-outline-secondary btn-block">
                        <i class="fas fa-cog mr-2"></i>Notification Settings
                    </a>
                </div>
            </div>
        </div>

        <!-- Department Groups -->
        {% if user_departments %}
        <div class="card mt-3">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-building mr-2"></i>Your Departments
                </h3>
            </div>
            <div class="card-body">
                {% for dept in user_departments %}
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-users text-primary mr-2"></i>
                    <span>{{ dept.name }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Start DM Modal -->
<div class="modal fade" id="startDMModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Start Direct Message</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Search for a user:</label>
                    <input type="text" class="form-control" id="userSearch" placeholder="Type name or email...">
                </div>
                <div id="userSearchResults" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- New Group Modal -->
<div class="modal fade" id="newGroupModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Group</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createGroupForm">
                    <div class="form-group">
                        <label>Group Name:</label>
                        <input type="text" class="form-control" id="groupName" required>
                    </div>
                    <div class="form-group">
                        <label>Description (optional):</label>
                        <textarea class="form-control" id="groupDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Add Members:</label>
                        <input type="text" class="form-control" id="memberSearch" placeholder="Search users...">
                        <div id="memberSearchResults" class="mt-2"></div>
                        <div id="selectedMembers" class="mt-2"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createGroupBtn">Create Group</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
{% csrf_token %}
<script>
$(document).ready(function() {
    // Chat item click handler
    $('.chat-item').click(function() {
        const groupId = $(this).data('group-id');
        window.location.href = `/social/chat/${groupId}/`;
    });

    // Search chats
    $('#searchChats').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('.chat-item').each(function() {
            const chatName = $(this).find('h6').text().toLowerCase();
            const chatPreview = $(this).find('.chat-preview').text().toLowerCase();
            
            if (chatName.includes(searchTerm) || chatPreview.includes(searchTerm)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });

    // User search for DM
    let userSearchTimeout;
    $('#userSearch').on('input', function() {
        const query = $(this).val().trim();
        
        clearTimeout(userSearchTimeout);
        
        if (query.length < 2) {
            $('#userSearchResults').empty();
            return;
        }
        
        userSearchTimeout = setTimeout(() => {
            $.get('/social/api/users/search/', { q: query })
                .done(function(data) {
                    let html = '';
                    data.users.forEach(user => {
                        html += `
                            <div class="user-result p-2 border rounded mb-2" style="cursor: pointer;" data-user-id="${user.id}">
                                <div class="d-flex align-items-center">
                                    <img src="${user.profile_pic || '/static/dist/img/default-150x150.png'}" 
                                         class="rounded-circle mr-2" width="40" height="40">
                                    <div>
                                        <div class="font-weight-bold">${user.name}</div>
                                        <small class="text-muted">${user.email} - ${user.user_type}</small>
                                        ${user.is_online ? '<span class="badge badge-success badge-sm">Online</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    $('#userSearchResults').html(html);
                })
                .fail(function() {
                    $('#userSearchResults').html('<div class="alert alert-danger">Error searching users</div>');
                });
        }, 300);
    });

    // Start DM
    $(document).on('click', '.user-result', function() {
        const userId = $(this).data('user-id');
        
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", $('[name=csrfmiddlewaretoken]').val());
                }
            }
        });
        
        $.post('/social/api/dm/start/', { 
            user_id: userId,
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        })
            .done(function(data) {
                window.location.href = data.redirect_url;
            })
            .fail(function(xhr) {
                const error = xhr.responseJSON?.error || 'Failed to start conversation';
                alert(error);
            });
    });

    // Group creation functionality
    let selectedMembers = [];
    
    $('#memberSearch').on('input', function() {
        const query = $(this).val().trim();
        
        if (query.length < 2) {
            $('#memberSearchResults').empty();
            return;
        }
        
        $.get('/social/api/users/search/', { q: query })
            .done(function(data) {
                let html = '';
                data.users.forEach(user => {
                    if (!selectedMembers.find(m => m.id === user.id)) {
                        html += `
                            <div class="member-result p-2 border rounded mb-1" style="cursor: pointer;" data-user-id="${user.id}" data-user-name="${user.name}">
                                <div class="d-flex align-items-center">
                                    <img src="${user.profile_pic || '/static/dist/img/default-150x150.png'}" 
                                         class="rounded-circle mr-2" width="30" height="30">
                                    <span>${user.name}</span>
                                </div>
                            </div>
                        `;
                    }
                });
                $('#memberSearchResults').html(html);
            });
    });

    // Add member to group
    $(document).on('click', '.member-result', function() {
        const userId = $(this).data('user-id');
        const userName = $(this).data('user-name');
        
        selectedMembers.push({ id: userId, name: userName });
        $(this).remove();
        
        updateSelectedMembersDisplay();
    });

    function updateSelectedMembersDisplay() {
        let html = '';
        selectedMembers.forEach((member, index) => {
            html += `
                <span class="badge badge-primary mr-1 mb-1">
                    ${member.name}
                    <button type="button" class="btn btn-sm p-0 ml-1 text-white" onclick="removeMember(${index})" style="border: none; background: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </span>
            `;
        });
        $('#selectedMembers').html(html);
    }

    window.removeMember = function(index) {
        selectedMembers.splice(index, 1);
        updateSelectedMembersDisplay();
    };

    // Create group
    $('#createGroupBtn').click(function() {
        const name = $('#groupName').val().trim();
        const description = $('#groupDescription').val().trim();
        
        if (!name) {
            alert('Group name is required');
            return;
        }
        
        const memberIds = selectedMembers.map(m => m.id);
        
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", $('[name=csrfmiddlewaretoken]').val());
                }
            }
        });
        
        $.post('/social/api/groups/create/', {
            name: name,
            description: description,
            member_ids: memberIds,
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        })
        .done(function(data) {
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                location.reload();
            }
        })
        .fail(function(xhr) {
            const error = xhr.responseJSON?.error || 'Failed to create group';
            alert(error);
        });
    });

    // Reset modals when closed
    $('.modal').on('hidden.bs.modal', function() {
        $(this).find('form')[0]?.reset();
        $(this).find('.search-results').empty();
        selectedMembers = [];
        updateSelectedMembersDisplay();
    });
});
</script>
{% endblock %}
